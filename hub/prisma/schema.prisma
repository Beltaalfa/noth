// Hub - Portal Clientes + Admin
// Banco principal do sistema (PostgreSQL)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  client
  admin
}

enum Status {
  active
  inactive
}

enum DbConnectionType {
  postgres
  firebird
}

enum ToolType {
  report
  powerbi_report
  integration
  query_runner
  app
}

enum PrincipalType {
  user
  group
  sector
}

model User {
  id           String    @id @default(cuid())
  name         String
  email        String    @unique
  passwordHash String
  role         UserRole  @default(client)
  status       Status    @default(active)
  deletedAt    DateTime? // Soft delete
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  userClientPermissions UserClientPermission[]
  userGroupPermissions  UserGroupPermission[]
  userSectorPermissions UserSectorPermission[]
  userToolPermissions   UserToolPermission[]
  auditLogs             AuditLog[]
  helpdeskTicketsCreated HelpdeskTicket[]     @relation("TicketCreator")
  helpdeskTicketsAssigned HelpdeskTicket[]    @relation("TicketAssigneeUser")
  helpdeskMessages      HelpdeskMessage[]
  helpdeskNotifications HelpdeskNotification[]
  approvalConfigApprovers HelpdeskApprovalConfigApprover[]
  approvalLogs          HelpdeskApprovalLog[]

  @@index([deletedAt])
}

model Client {
  id        String    @id @default(cuid())
  name      String
  logoUrl   String?   // Caminho: /uploads/logos/xxx.png
  status    Status    @default(active)
  deletedAt DateTime? // Soft delete
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  groups         Group[]
  dbConnections  DbConnection[]
  tools          Tool[]
  userPermissions UserClientPermission[]
  clientTools     ClientTool[]
  helpdeskTickets HelpdeskTicket[]
  helpdeskApprovalConfigs HelpdeskApprovalConfig[]
  helpdeskTenant HelpdeskTenant?

  @@index([deletedAt])
}

model HelpdeskTenant {
  id         String   @id @default(cuid())
  clientId   String   @unique
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  dbName     String
  dbHost     String
  dbPort     Int
  dbUser     String
  dbPassword String
  dbSsl      Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([clientId])
}

model Group {
  id        String   @id @default(cuid())
  name      String
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sectors   Sector[]
  userPermissions UserGroupPermission[]
  helpdeskTickets HelpdeskTicket[] @relation("TicketAssigneeGroup")
  helpdeskApprovalConfigs HelpdeskApprovalConfig[]

  @@index([clientId])
}

model Sector {
  id        String   @id @default(cuid())
  name      String
  groupId   String
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userPermissions UserSectorPermission[]
  helpdeskTickets HelpdeskTicket[] @relation("TicketAssigneeSector")
  helpdeskApprovalConfigs HelpdeskApprovalConfig[]

  @@index([groupId])
}

model DbConnection {
  id          String            @id @default(cuid())
  clientId    String
  client      Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  type        DbConnectionType
  host        String
  port        Int
  user        String
  password    String            // Criptografado
  database    String
  extraParams String?           // JSON string para parâmetros extras
  status      Status            @default(active)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  tools           Tool[]

  @@index([clientId])
}

model Tool {
  id              String   @id @default(cuid())
  clientId        String
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  dbConnectionId  String?
  dbConnection    DbConnection? @relation(fields: [dbConnectionId], references: [id], onDelete: SetNull)
  name            String
  slug            String
  description     String?
  type            ToolType @default(report)
  powerbiUrl      String?  // URL do relatório Power BI/Fabric
  status          Status   @default(active)
  scriptConfig    String?  // JSON: configuração de script/query
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  userPermissions   UserToolPermission[]
  clientTools       ClientTool[]
  toolPermissions   ToolPermission[]

  @@unique([clientId, slug])
  @@index([clientId])
}

// Permissões ferramenta -> usuário/grupo/setor (para relatórios)
model ToolPermission {
  id             String       @id @default(cuid())
  toolId         String
  tool           Tool         @relation(fields: [toolId], references: [id], onDelete: Cascade)
  principalType  PrincipalType
  principalId    String
  createdAt      DateTime     @default(now())

  @@unique([toolId, principalType, principalId])
  @@index([toolId])
  @@index([principalType, principalId])
}

// Permissões usuário <-> cliente
model UserClientPermission {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, clientId])
  @@index([userId])
  @@index([clientId])
}

// Permissões usuário <-> grupo
model UserGroupPermission {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId   String
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
}

// Permissões usuário <-> setor
model UserSectorPermission {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sectorId  String
  sector    Sector   @relation(fields: [sectorId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, sectorId])
  @@index([userId])
  @@index([sectorId])
}

// Permissões usuário <-> ferramenta (opcional, granulação extra)
model UserToolPermission {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  toolId    String
  tool      Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, toolId])
  @@index([userId])
  @@index([toolId])
}

// Cliente <-> Ferramentas (N:N)
model ClientTool {
  id        String   @id @default(cuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  toolId    String
  tool      Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([clientId, toolId])
  @@index([clientId])
  @@index([toolId])
}

// Helpdesk
enum HelpdeskTicketStatus {
  open
  in_progress
  closed
  pending_approval
  in_approval
  rejected
  approved
  cancelled
}

enum HelpdeskApprovalType {
  hierarchical
  by_level
}

enum HelpdeskApprovalAction {
  approved
  rejected
}

enum HelpdeskAssigneeType {
  user
  group
  sector
}

model HelpdeskTicket {
  id              String              @id @default(cuid())
  clientId        String
  client          Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  subject         String?
  status          HelpdeskTicketStatus @default(open)
  assigneeType    HelpdeskAssigneeType
  assigneeUserId  String?
  assigneeUser    User?               @relation("TicketAssigneeUser", fields: [assigneeUserId], references: [id], onDelete: SetNull)
  assigneeGroupId String?
  assigneeSectorId String?
  group           Group?              @relation("TicketAssigneeGroup", fields: [assigneeGroupId], references: [id], onDelete: SetNull)
  sector          Sector?             @relation("TicketAssigneeSector", fields: [assigneeSectorId], references: [id], onDelete: SetNull)
  createdById     String
  creator         User                @relation("TicketCreator", fields: [createdById], references: [id], onDelete: Cascade)
  slaLimitHours   Int?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  messages HelpdeskMessage[]
  notifications HelpdeskNotification[]
  approvalLogs   HelpdeskApprovalLog[]

  @@index([clientId])
  @@index([createdById])
  @@index([assigneeUserId])
  @@index([assigneeGroupId])
  @@index([assigneeSectorId])
  @@index([status])
  @@index([createdAt])
}

model HelpdeskMessage {
  id                    String    @id @default(cuid())
  ticketId              String
  ticket                HelpdeskTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  content               String    @db.Text
  forwardedFromMessageId String?
  createdAt             DateTime  @default(now())

  attachments HelpdeskAttachment[]
  notifications HelpdeskNotification[]

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
}

model HelpdeskAttachment {
  id        String   @id @default(cuid())
  messageId String
  message   HelpdeskMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  filename  String
  mimeType  String
  size      Int      // bytes
  storagePath String // path relativo: helpdesk/{ticketId}/{messageId}/{filename}
  createdAt DateTime @default(now())

  @@index([messageId])
}

model HelpdeskNotification {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  ticketId  String
  ticket    HelpdeskTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  messageId String?
  message   HelpdeskMessage? @relation(fields: [messageId], references: [id], onDelete: Cascade)
  type      String    // new_ticket, new_message, awaiting_approval, approved, rejected, returned_for_revision
  readAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([ticketId])
  @@index([readAt])
}

model HelpdeskApprovalConfig {
  id             String              @id @default(cuid())
  clientId       String
  client         Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  groupId        String?
  group          Group?              @relation(fields: [groupId], references: [id], onDelete: Cascade)
  sectorId       String?
  sector         Sector?             @relation(fields: [sectorId], references: [id], onDelete: Cascade)
  exigeAprovacao Boolean             @default(true)
  tipoAprovacao  HelpdeskApprovalType @default(by_level)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  approvers HelpdeskApprovalConfigApprover[]

  @@index([clientId])
  @@index([groupId])
  @@index([sectorId])
}

model HelpdeskApprovalConfigApprover {
  id       String                @id @default(cuid())
  configId String
  config   HelpdeskApprovalConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  userId   String
  user     User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  ordem    Int?
  nivel    Int?
  createdAt DateTime             @default(now())

  @@unique([configId, userId])
  @@index([configId])
  @@index([userId])
}

model HelpdeskApprovalLog {
  id        String                @id @default(cuid())
  ticketId  String
  ticket    HelpdeskTicket        @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId    String
  user      User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  action    HelpdeskApprovalAction
  comment   String?               @db.Text
  createdAt DateTime              @default(now())

  @@index([ticketId])
  @@index([userId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    String   // create, update, delete, login, etc.
  entity    String   // User, Client, Group, etc.
  entityId  String?
  details   String?  // JSON
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}
